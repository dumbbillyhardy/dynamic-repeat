<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="temp-latizer.html">
<dom-module id="dynamic-repeat">
    <template>
        <slot id="slot"></slot>
    </template>
    <script>
        Polymer({
            is: 'dynamic-repeat',

            behaviors: [Polymer.Templatizer],

            properties: {
                items: {
                    type: Array,
                    observer: "_generate"
                },
                as: {
                    type: String,
                    value: "item"
                },
                attribute: {
                    type: String,
                    value: "for"
                },
                properties: {
                    type: Array,
                    value: function() {
                        return ["prop", "type"];
                    }
                }
            },

            observers: ["_forwardProps(as)"],

            _forwardProps(as) {
                if (this.templatizerMap) {
                    this.templatizerMap.values()
                        .forEach(node => {
                            node.as = as;
                        });
                }
            },

            ready() {
                this.templatizerMap = new Map();
                this._observer = Polymer.dom(this.$.slot).observeNodes(({addedNodes, removedNodes}) => {
                    removedNodes.forEach(node => {
                        const foor = this._getIdentifier(node, this.attribute);
                        this.templatizerMap.delete(foor);
                    });
                    addedNodes.filter(node => node.nodeName === "TEMPLATE").forEach(node => {
                        const foor = this._getIdentifier(node, this.attribute);
                        this.templatizerMap.set(foor, this._generateTemplatizer(node));
                    });
                    if(this.items) {
                        this._generate();
                    }
                });
            },

            _getIdentifier(node, attr) {
                return node[attr] || node.getAttribute(attr) || "";
            },

            _generateTemplatizer(template) {
                const el = document.createElement("temp-latizer");
                el.template = template;
                el.as = this.as;
                return el;
            },

            _getTemplatizer(column) {
                let templatizer = this.properties.reduce((acc, val) => {
                    if(!acc) {
                        acc = this.templatizerMap.get(column[val]);
                    }
                    return acc;
                }, null);
                templatizer = templatizer || this.templatizerMap.get("");
                return templatizer;
            },

            _getInstance(column) {
                const templatizer = this._getTemplatizer(column);
                return templatizer.generate(column);
            },

            _generate() {
                if(this.items != null) {
                    (this._instances || []).forEach(inst => {
                        for(let i=0; i<inst.children.length; i++) {
                            inst.root.appendChild(inst.children[i]);
                        }
                    });
                    this._instances = this.items.map(this._getInstance.bind(this))
                        .map(inst => {
                            Polymer.dom(Polymer.dom(this).parentNode).insertBefore(inst.root, this);
                            return inst;
                        });
                }
            },
        });
    </script>
</dom-module>
